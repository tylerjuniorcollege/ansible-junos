---
- name: Install Junos OS - EX3400
  hosts: Junos_all
  roles:
    - Juniper.junos 
  connection: local
  gather_facts: no
  
  vars:
    OS_version: 20.2R1-S2.1
    OS_package: junos-arm-32-20.2R1-S2.1.tgz
    pkg_dir: /var/lib/awx/custom-venv/junos/Firmware
    wait_time_after_reboot: 300
    netconf_port: 830


  tasks:

    - name: Install Junos OS package
      juniper_junos_software:
        version: "{{ OS_version }}"
        local_package: "{{ pkg_dir }}/{{ OS_package }}"
        reboot: no
        force_host: true
        kwargs: {"no-copy": true,"force": true,"unlink": true}
    
  
    - name: Reboot all REs on the device
      juniper_junos_system:
        action: "reboot"
        all_re: true
      register: result
      notify:
      - pause_for_reboot
      - wait_reboot


    - name: Print response
      debug:
        var: result

  handlers:
    - name: pause_for_reboot
      pause: 
        seconds: 180
      when: result.reboot 
    - name: wait_reboot
      wait_for: 
        host: "{{ ansible_host }}"
        port: "{{ netconf_port  }}"
        timeout: "{{ wait_time_after_reboot }}"
      when: result.reboot
